<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Picard API</title>
    <style>
        body { 
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f9f9f9; 
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 5px;
        }

        .product {
            border: 1px solid #ddd;
            padding: 10px;
            margin: 10px 0;
            background: #fafafa;
        }

        .btn {
            padding: 5px 10px;
            margin: 3px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }

        .btn-primary {
            background: #007bff;
            color: white;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        #cart {
            border-bottom: 1px solid #000000ff;
            padding: 15px;
            margin: 15px 0;
        }

        .cart-item {
            border: 1px solid #ccc;
            padding: 10px;
            margin: 5px 0;
            background: white;
        }

        .unavailable {
            opacity: 0.6;
        }

        input {
            padding: 3px;
            margin-right: 5px;
            width: 50px;
        }

        img {
            width: 150px;
            height: 100px;
            object-fit: cover;
            margin-bottom: 5px;
        }

        h1 {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Picard API:</h1>
        
        <div id="cart">
            <h3>Panier (ID: <span id="cart-id">-</span>)</h3>
            <button class="btn btn-success" onclick="createCart()">Créer panier</button>
            <button class="btn btn-primary" onclick="validateCart()">Valider panier</button>

            <div id="items-list">Appuyer sur "Créer panier", puis choisisser vos produits</div>
            <div id="total" style="display:none;">Total: <span id="amount">0</span>€</div>
        </div>
        
        <h3>Produits</h3>
        {% for product in products %}
            <div class="product {{ not product.isAvailable ? 'unavailable' : '' }}">
                {% if product.image %}
                    <img src="{{ product.image }}" alt="{{ product.name }}">
                {% endif %}
                <h4>{{ product.name }}</h4>
                <p>{{ product.description }}</p>
                <p><strong>{{ product.price }}€</strong> - Note: {{ product.rating ?? 'Non noté' }}/5</p>
                <p>{{ product.isAvailable ? 'Disponible' : 'Indisponible' }}</p>
                
                {% if product.isAvailable %}
                    <button class="btn btn-primary" onclick="addToCart({{ product.id }})">Ajouter</button>
                {% endif %}
                
                <input type="number" id="rate-{{ product.id }}" min="0" max="5" step="0.1" placeholder="Note">
                <button class="btn btn-success" onclick="rateProduct({{ product.id }})">Noter</button>
            </div>
        {% endfor %}
    </div>

    <script>
        let cartId = null;
        
        function createCart() {
            fetch('/api/carts', { method: 'POST' })
                .then(r => r.json())
                .then(data => {
                    cartId = data.id;
                    document.getElementById('cart-id').textContent = data.id;
                    document.getElementById('load-btn').style.display = 'inline';
                    alert('Panier créé: ' + data.id);
                });
        }
        
        function addToCart(productId) {
            if (!cartId) return alert('Créez un panier d\'abord');
            
            fetch('/api/cart-items', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ cart_id: cartId, product_id: productId, quantity: 1 })
            })
            .then(r => r.json())
            .then(() => {
                alert('Produit ajouté');
                loadCartItems();
            });
        }
        
        function loadCartItems() {
            if (!cartId) return;
            
            fetch('/api/carts/' + cartId)
                .then(r => r.json())
                .then(cart => {
                    const list = document.getElementById('items-list');
                    const total = document.getElementById('total');
                    
                    if (cart.cartItems && cart.cartItems.length > 0) {
                        let html = '';
                        let sum = 0;
                        
                        cart.cartItems.forEach(item => {
                            const itemTotal = item.quantity * item.product.price;
                            sum += itemTotal;
                            html += `<div class="cart-item">
                                ${item.product.name} - ${itemTotal}€
                                <button class="btn btn-danger" onclick="removeItem(${item.id})">X</button>
                            </div>`;
                        });
                        
                        list.innerHTML = html;
                        document.getElementById('amount').textContent = sum.toFixed(2);
                        total.style.display = 'block';
                    } else {
                        list.innerHTML = 'Panier vide';
                        total.style.display = 'none';
                    }
                });
        }
        
        function removeItem(itemId) {
            fetch('/api/cart-items/' + itemId, { method: 'DELETE' })
                .then(() => {
                    alert('Article supprimé');
                    loadCartItems();
                });
        }
        
        function rateProduct(productId) {
            const rating = document.getElementById('rate-' + productId).value;
            if (!rating) return alert('Entrez une note');
            
            fetch('/api/products/' + productId + '/rate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ rating: parseFloat(rating) })
            })
            .then(() => {
                alert('Produit noté');
                location.reload();
            });
        }
        
        function validateCart() {
            if (!cartId) return alert('Aucun panier');
            
            fetch('/api/carts/' + cartId + '/validate', { method: 'PATCH' })
                .then(() => {
                    alert('Panier validé');
                    cartId = null;
                    document.getElementById('cart-id').textContent = '-';
                    document.getElementById('load-btn').style.display = 'none';
                    document.getElementById('items-list').innerHTML = 'Aucun panier';
                    document.getElementById('total').style.display = 'none';
                });
        }
    </script>
</body>
</html>